<div class="p-6">
  <div class="flex items-start justify-between gap-4 mb-6">
    <div class="flex items-start gap-3">
      <button
        (click)="goBack()"
        class="px-3 py-2 rounded-lg border border-[var(--color-border-default)] hover:bg-[var(--color-bg-hover)]"
      >
        Retour
      </button>
      <div>
        <h1 class="text-2xl font-semibold text-[var(--color-text-primary)]">Cartes de service</h1>
        <p class="text-sm text-[var(--color-text-muted)]">Génération des badges ISO ID-1 (recto/verso)</p>
      </div>
    </div>

    <div class="flex gap-2 flex-wrap">
      <button
        (click)="downloadPdf()"
        class="px-3 py-2 rounded-lg border border-purple-300 bg-purple-50 text-purple-700 hover:bg-purple-100 transition text-sm font-medium flex items-center gap-2"
      >
        <i class="fas fa-file-pdf"></i>
        PDF
      </button>
      <button
        (click)="downloadImage('png')"
        class="px-3 py-2 rounded-lg border border-indigo-300 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 transition text-sm font-medium flex items-center gap-2"
      >
        <i class="fas fa-image"></i>
        PNG
      </button>
      <button
        (click)="downloadImage('jpg')"
        class="px-3 py-2 rounded-lg border border-blue-300 bg-blue-50 text-blue-700 hover:bg-blue-100 transition text-sm font-medium flex items-center gap-2"
      >
        <i class="fas fa-image"></i>
        JPG
      </button>
      <button
        (click)="downloadMultiplePdf()"
        class="px-3 py-2 rounded-lg border border-gray-300 bg-gray-50 text-gray-700 hover:bg-gray-100 transition text-sm font-medium flex items-center gap-2"
        title="Télécharger toutes les cartes (si autorisé)"
      >
        <i class="fas fa-layer-group"></i>
        PDF (toutes)
      </button>
    </div>
  </div>

  @if (error()) {
    <div class="mb-4 p-3 rounded-lg bg-red-50 text-red-700 border border-red-200">{{ error() }}</div>
  }

  @if (loading()) {
    <div class="flex flex-col items-center justify-center py-12 gap-4">
      <i class="fas fa-spinner animate-spin text-2xl" style="color: var(--color-text-muted);"></i>
      <p style="color: var(--color-text-muted);">Chargement...</p>
    </div>
  } @else {
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="rounded-lg border border-[var(--color-border-default)] bg-[var(--color-bg-surface)] p-4">
        <div class="text-sm font-semibold text-[var(--color-text-primary)]">Utilisateur</div>
        <div class="text-xs text-[var(--color-text-muted)] mt-1">
          @if (user()) {
            <div>{{ user()!.identite.prenom }} {{ user()!.identite.nom }} • {{ user()!.identite.login }}</div>
            <div class="mt-1">{{ user()!.identite.email }}</div>
          } @else {
            <div>-</div>
          }
        </div>

        <div class="mt-4">
          <label class="block text-xs font-semibold text-[var(--color-text-muted)] uppercase tracking-wider mb-1">Service</label>
          <select
            class="w-full px-3 py-2 rounded-lg border border-[var(--color-border-default)] bg-transparent"
            [value]="selectedServiceId() ?? ''"
            (change)="onSelectService(($any($event.target)).value)"
          >
            @if (services().length === 0) {
              <option value="">Aucun service affecté</option>
            }
            @for (s of services(); track s.id) {
              <option [value]="s.id">{{ s.nom }}</option>
            }
          </select>

          <div class="mt-3 text-xs text-[var(--color-text-muted)]">
            Format impression: ISO ID-1 (85.60 × 53.98 mm)
          </div>
        </div>
      </div>

      <div class="lg:col-span-2 rounded-lg border border-[var(--color-border-default)] bg-[var(--color-bg-surface)] p-4">
        <div class="text-sm font-semibold text-[var(--color-text-primary)] mb-3">Aperçu (HTML)</div>

        @if (previewUrl()) {
          <div class="overflow-auto">
            <!--
              On encapsule l'iframe dans un conteneur qui simule un plan de travail.
              Le contenu HTML renvoyé par l'API doit être en dimensions ISO.
            -->
            <div class="p-4 bg-[var(--color-bg-hover)] rounded-lg border border-[var(--color-border-default)] inline-block">
              <iframe
                [src]="previewUrl()!"
                style="width: 900px; height: 520px; border: 0; background: transparent;"
                title="Aperçu carte"
              ></iframe>
            </div>
          </div>
        } @else {
          <div class="text-sm text-[var(--color-text-muted)]">Sélectionne un service pour voir l'aperçu.</div>
        }

        <div class="mt-3 text-xs text-[var(--color-text-muted)]">
          Astuce: utilise PDF/PNG pour l'impression. L'aperçu est une prévisualisation.
        </div>
      </div>
    </div>
  }
</div>
