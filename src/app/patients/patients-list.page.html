<div class="p-6">
  <!-- En-tête -->
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-[var(--color-text-primary)]">Gestion des Patients</h1>
    <p class="text-[var(--color-text-secondary)] mt-1">Gérez tous les patients de l'établissement</p>
  </div>

  <!-- Actions -->
  <div class="flex flex-wrap gap-3 mb-6">
    @if (canCreatePatient()) {
      <a
        routerLink="/patients/create"
        class="btn btn-primary"
      >
        <i class="fas fa-plus"></i> Nouveau Patient
      </a>
    }
    <button
      (click)="exportCSV()"
      class="btn btn-secondary"
    >
      <i class="fas fa-download"></i> Export CSV
    </button>
    <button
      (click)="showSearchForm.set(!showSearchForm())"
      class="btn btn-secondary"
    >
      <i class="fas fa-search"></i> Recherche Avancée
    </button>
  </div>

  <!-- Messages d'erreur -->
  @if (error()) {
    <div class="bg-red-100 border border-[var(--color-error)] text-[var(--color-error)] px-4 py-3 rounded-lg mb-6 flex items-center gap-2">
      <i class="fas fa-exclamation-circle"></i> {{ error() }}
    </div>
  }

  <!-- Formulaire de recherche avancée -->
  @if (showSearchForm()) {
    <div class="card p-6 mb-6">
      <h3 class="text-lg font-semibold text-[var(--color-text-primary)] mb-4">Recherche Avancée</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-[var(--color-text-secondary)] mb-2">Nom</label>
          <input
            type="text"
            [(ngModel)]="searchNom"
            placeholder="Entrez le nom"
            class="w-full"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-[var(--color-text-secondary)] mb-2">Prénom</label>
          <input
            type="text"
            [(ngModel)]="searchPrenom"
            placeholder="Entrez le prénom"
            class="w-full"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-[var(--color-text-secondary)] mb-2">Groupe Sanguin</label>
          <select
            [(ngModel)]="searchGroupeSanguin"
            class="w-full"
          >
            <option value="">-- Tous --</option>
            <option value="O+">O+</option>
            <option value="O-">O-</option>
            <option value="A+">A+</option>
            <option value="A-">A-</option>
            <option value="B+">B+</option>
            <option value="B-">B-</option>
            <option value="AB+">AB+</option>
            <option value="AB-">AB-</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-[var(--color-text-secondary)] mb-2">Statut</label>
          <select
            [(ngModel)]="searchActif"
            class="w-full"
          >
            <option [ngValue]="null">-- Tous --</option>
            <option [ngValue]="true">Actif</option>
            <option [ngValue]="false">Inactif</option>
          </select>
        </div>
      </div>
      <div class="flex gap-3">
        <button
          (click)="search()"
          class="btn btn-primary"
        >
          <i class="fas fa-search"></i> Rechercher
        </button>
        <button
          (click)="resetSearch()"
          class="btn btn-secondary"
        >
          <i class="fas fa-redo"></i> Réinitialiser
        </button>
      </div>
    </div>
  }

  <!-- Tableau des patients -->
  <div class="card overflow-hidden">
    @if (loading()) {
      <div class="p-8 text-center text-[var(--color-text-muted)]">
        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
        <p>Chargement...</p>
      </div>
    } @else if (patients().length === 0) {
      <div class="p-8 text-center text-[var(--color-text-muted)]">
        <i class="fas fa-inbox text-4xl mb-2"></i>
        <p>Aucun patient trouvé</p>
      </div>
    } @else {
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-[var(--color-bg-hover)] border-b border-[var(--color-border-default)]">
            <tr>
              <th class="px-6 py-3 text-left text-sm font-semibold text-[var(--color-text-primary)]">ID</th>
              <th class="px-6 py-3 text-left text-sm font-semibold text-[var(--color-text-primary)]">Nom</th>
              <th class="px-6 py-3 text-left text-sm font-semibold text-[var(--color-text-primary)]">Prénom</th>
              <th class="px-6 py-3 text-left text-sm font-semibold text-[var(--color-text-primary)]">Email</th>
              <th class="px-6 py-3 text-left text-sm font-semibold text-[var(--color-text-primary)]">Téléphone</th>
              <th class="px-6 py-3 text-left text-sm font-semibold text-[var(--color-text-primary)]">Groupe Sanguin</th>
              <th class="px-6 py-3 text-left text-sm font-semibold text-[var(--color-text-primary)]">Statut</th>
              <th class="px-6 py-3 text-left text-sm font-semibold text-[var(--color-text-primary)]">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (patient of patients(); track patient.id) {
              <tr
                class="border-b border-[var(--color-border-default)] hover:bg-[var(--color-bg-hover)] transition-colors"
                [class.opacity-50]="!patient.actif"
              >
                <td class="px-6 py-4 text-sm text-[var(--color-text-primary)]">{{ patient.id }}</td>
                <td class="px-6 py-4 text-sm text-[var(--color-text-primary)]">{{ patient.nom }}</td>
                <td class="px-6 py-4 text-sm text-[var(--color-text-primary)]">{{ patient.prenom }}</td>
                <td class="px-6 py-4 text-sm text-[var(--color-text-primary)]">{{ patient.email }}</td>
                <td class="px-6 py-4 text-sm text-[var(--color-text-primary)]">{{ patient.telephone }}</td>
                <td class="px-6 py-4 text-sm">
                  <span class="badge badge-info">
                    {{ patient.groupeSanguin || 'N/A' }}
                  </span>
                </td>
                <td class="px-6 py-4 text-sm">
                  <span
                    [class]="patient.actif ? 'badge badge-success' : 'badge badge-error'"
                  >
                    {{ patient.actif ? 'Actif' : 'Inactif' }}
                  </span>
                </td>
                <td class="px-6 py-4 text-sm flex gap-2">
                  <a
                    [routerLink]="['/patients', patient.id]"
                    class="text-[var(--color-primary)] hover:text-[var(--color-primary-hover)] transition-colors"
                    title="Voir"
                  >
                    <i class="fas fa-eye"></i>
                  </a>
                  @if (canEditPatient()) {
                    <a
                      [routerLink]="['/patients', patient.id, 'edit']"
                      class="text-[var(--color-primary)] hover:text-[var(--color-primary-hover)] transition-colors"
                      title="Modifier"
                    >
                      <i class="fas fa-edit"></i>
                    </a>
                  }
                  <button
                    (click)="exportPatientPDF(patient.id)"
                    class="text-[var(--color-error)] hover:text-[var(--color-error)] transition-colors"
                    title="Export PDF"
                  >
                    <i class="fas fa-file-pdf"></i>
                  </button>
                  @if (canDeletePatient()) {
                    <button
                      (click)="deletePatient(patient.id)"
                      class="text-[var(--color-error)] hover:text-[var(--color-error)] transition-colors"
                      title="Supprimer"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>

  <!-- Pagination -->
  @if (patients().length > 0) {
    <div class="flex justify-center items-center gap-6 mt-6">
      <button
        (click)="previousPage()"
        [disabled]="currentPage() === 1"
        class="btn btn-secondary"
      >
        <i class="fas fa-chevron-left"></i> Précédent
      </button>
      <span class="text-[var(--color-text-secondary)] font-medium">
        Page {{ currentPage() }} sur {{ totalPages }} ({{ totalPatients() }} patients)
      </span>
      <button
        (click)="nextPage()"
        [disabled]="currentPage() === totalPages"
        class="btn btn-secondary"
      >
        Suivant <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  }
</div>
